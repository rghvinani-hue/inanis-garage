<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Inanis Garage - Vehicle Details</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet"/>
  <link href="{{ url_for('static', filename='css/apple-style.css') }}" rel="stylesheet"/>
</head>
<body>
  <nav class="navbar navbar-expand-lg apple-nav">
    <div class="container">
      <a class="navbar-brand" href="{{ url_for('index') }}">
        <i class="fas fa-wrench me-2"></i>Inanis Garage
      </a>
      <div class="navbar-nav ms-auto">
        <a class="nav-link" href="{{ url_for('index') }}">‚Üê Back to Garage</a>
        <a class="nav-link" href="{{ url_for('logout') }}"><i class="fas fa-sign-out-alt me-1"></i>Logout</a>
      </div>
    </div>
  </nav>

  <div class="container mt-4 apple-fade-in">

    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for category, message in messages %}
          <div class="apple-alert apple-alert-{{ 'danger' if category=='error' else ('warning' if category=='warning' else 'success') }}">
            <i class="fas fa-{{ 'exclamation-triangle' if category=='error' else ('exclamation-circle' if category=='warning' else 'check-circle') }} me-2"></i>
            {{ message }}
          </div>
        {% endfor %}
      {% endif %}
    {% endwith %}

    <!-- Vehicle Details & Fuel Efficiency -->
    <div class="row g-4 mb-4">
      <!-- Vehicle Details -->
      <div class="col-lg-8">
        <div class="apple-card apple-slide-up">
          <div class="apple-card-header">
            <i class="fas fa-car me-2"></i>Vehicle Details: {{ v.reg_no }}
          </div>
          <div class="apple-card-body">
            <div class="d-flex align-items-center mb-4">
              <div class="me-4">
                <img src="{{ v.thumbnail_url or url_for('static', filename='images/default-car.png') }}"
                     alt="{{ v.make }} {{ v.model }}"
                     style="width:80px; height:80px; object-fit:cover; border-radius:50%;">
              </div>
              <div>
                <h3 class="mb-1">{{ v.make }} {{ v.model }}</h3>
                <small class="text-muted">Registration: {{ v.reg_no }}</small>
              </div>
            </div>
            <div class="row">
              <div class="col-md-4">
                <small class="text-muted d-block">Manufacturing Year</small>
                <strong>{{ v.year }}</strong>
              </div>
              <div class="col-md-4">
                <small class="text-muted d-block">Current Odometer</small>
                <strong>{{ "{:,}".format(v.odo|int) }} km</strong>
              </div>
              <div class="col-md=4">
                <small class="text-muted d-block">Color</small>
                <strong>{{ v.color }}</strong>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Fuel Efficiency & Drive Links -->
      <div class="col-lg-4">
        <div class="apple-card apple-slide-up" style="animation-delay:0.2s;">
          <div class="apple-card-header">
            <i class="fas fa-tachometer-alt me-2"></i>Fuel Efficiency
          </div>
          <div class="apple-card-body text-center">
            {% if flogs and flogs[-1].fuel_efficiency %}
              <div style="font-size:2rem; font-weight:700; color:var(--apple-dark-gray);">
                {{ flogs[-1].fuel_efficiency }} km/L
              </div>
              <small class="text-muted">Last log: {{ flogs[-1].date }}</small>
            {% else %}
              <span class="text-muted">No fuel data</span>
            {% endif %}
          </div>
          {% if docs|selectattr('drive_link')|list %}
          <div class="list-group list-group-flush">
            {% for doc in docs if doc.drive_link %}
            <a href="{{ doc.drive_link }}" target="_blank"
               class="list-group-item list-group-item-action"
               style="font-size:0.85rem;">
              <i class="fas fa-cloud me-1"></i>{{ doc.type }} in Drive
            </a>
            {% endfor %}
          </div>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- Add Fuel Log & Documents -->
    <div class="row g-4 mb-4">
      <!-- Add Fuel Log -->
      <div class="col-lg-6">
        <div class="apple-card apple-slide-up">
          <div class="apple-card-header">
            <i class="fas fa-gas-pump me-2"></i>Add Fuel Log
          </div>
          <div class="apple-card-body">
            <form method="POST" action="{{ url_for('add_fuel', car_id=v.reg_no) }}">
              <div class="row g-3">
                <div class="col-6">
                  <label class="form-label">Previous Odometer</label>
                  <input type="text" class="form-control" value="{{ flogs[-1].curr_odo if flogs else v.odo }}" readonly>
                </div>
                <div class="col-6">
                  <label class="form-label">Current Odometer *</label>
                  <input type="number" step="0.1" name="curr_odo" class="form-control" required>
                </div>
                <div class="col-6">
                  <label class="form-label">Fuel Liters *</label>
                  <input type="number" step="0.01" name="liters" class="form-control" required>
                </div>
                <div class="col-6">
                  <label class="form-label">Date *</label>
                  <input type="date" name="date" class="form-control" value="{{ today }}" required>
                </div>
              </div>
              <button type="submit" class="btn btn-success w-100 mt-3">
                <i class="fas fa-plus me-1"></i>Add Fuel Log
              </button>
            </form>
          </div>
        </div>
      </div>

      <!-- Vehicle Documents -->
      <div class="col-lg-6">
        {% if docs %}
        <div class="apple-card mb-4 apple-slide-up" style="animation-delay:0.2s;">
          <div class="apple-card-header">
            <i class="fas fa-file-alt me-2" style="color:var(--apple-blue);"></i>
            Vehicle Documents ({{ docs|length }})
          </div>
          <div class="apple-card-body">
            {% for doc in docs %}
            <div class="document-item mb-3 p-3" style="background:rgba(255,255,255,0.7); border-radius:12px; border-left:4px solid
                {% if doc.expiry_status=='expired' %}var(--apple-red)
                {% elif doc.expiry_status=='expiring_soon' %}var(--apple-orange)
                {% else %}var(--apple-blue){% endif %};">
              <div class="d-flex justify-content-between align-items-start">
                <div class="flex-grow-1">
                  <div class="d-flex align-items-center mb-2">
                    <i class="fas fa-file-pdf me-2" style="color:
                      {% if doc.type=='Insurance' %}var(--apple-green)
                      {% elif doc.type=='Emission Test' %}var(--apple-orange)
                      {% elif doc.type=='RC Copy' %}var(--apple-blue)
                      {% else %}var(--apple-gray){% endif %};"></i>
                    <span class="fw-bold">{{ doc.type }}</span>
                    {% if doc.expiry_alert %}
                    <span class="badge ms-2" style="background:
                      {% if doc.expiry_status=='expired' %}var(--apple-red)
                      {% elif doc.expiry_status=='expiring_soon' %}var(--apple-orange)
                      {% else %}var(--apple-green){% endif %}; color:white; font-size:0.7rem;">
                      {{ doc.expiry_alert }}
                    </span>
                    {% endif %}
                  </div>
                  {% if doc.expiry %}
                  <div class="mb-2">
                    <small class="text-muted">
                      <i class="fas fa-calendar me-1"></i>
                      Expires: <strong>{{ doc.expiry }}</strong>
                    </small>
                  </div>
                  {% endif %}
                  <div class="mb-2">
                    <small class="text-muted">
                      <i class="fas fa-upload me-1"></i>
                      Uploaded: {{ doc.uploaded_date[:10] if doc.uploaded_date else 'Recently' }}
                      {% if doc.uploaded_by %} by {{ doc.uploaded_by }}{% endif %}
                    </small>
                  </div>
                  {% if doc.storage_location %}
                  <div class="mb-2">
                    <small class="text-muted">
                      <i class="fas fa-database me-1"></i>
                      Storage: {{ doc.storage_location }}
                    </small>
                  </div>
                  {% endif %}
                  {% if doc.notes %}
                  <div class="mb-2">
                    <small class="text-muted">
                      <i class="fas fa-sticky-note me-1"></i>{{ doc.notes }}
                    </small>
                  </div>
                  {% endif %}
                </div>
                <div class="text-end">
                  <div class="d-flex flex-column gap-2">
                    {% if doc.document_url %}
                    <a href="{{ doc.document_url }}" target="_blank"
                       class="apple-btn apple-btn-primary" style="padding:8px 16px; font-size:0.85rem;">
                      <i class="fas fa-eye me-1"></i>View Document
                    </a>
                    {% endif %}
                    {% if doc.drive_link %}
                    <a href="{{ doc.drive_link }}" target="_blank"
                       class="apple-btn apple-btn-secondary" style="padding:6px 12px; font-size:0.8rem;">
                      <i class="fas fa-cloud me-1"></i>Google Drive
                    </a>
                    {% endif %}
                    {% if not doc.document_url and not doc.drive_link and doc.local_view_url %}
                    <a href="{{ doc.local_view_url }}" target="_blank"
                       class="apple-btn apple-btn-secondary" style="padding:6px 12px; font-size:0.8rem;">
                      <i class="fas fa-eye me-1"></i>View Document
                    </a>
                    {% endif %}
                    {% if not doc.document_url and not doc.drive_link and not doc.local_view_url %}
                    <small class="text-muted text-center">
                      <i class="fas fa-info-circle me-1"></i>File stored locally
                    </small>
                    {% endif %}
                  </div>
                  <div class="mt-2">
                    <small class="text-muted d-block">
                      <i class="fas fa-file me-1"></i>{{ doc.original_filename or doc.filename }}
                    </small>
                    {% if doc.file_size %}
                    <small class="text-muted d-block">
                      <i class="fas fa-weight me-1"></i>{{ (doc.file_size/1024/1024)|round(1) }} MB
                    </small>
                    {% endif %}
                  </div>
                </div>
              </div>
            </div>
            {% endfor %}
            <div class="mt-3 p-3" style="background:rgba(0,122,255,0.1); border-radius:12px;">
              <div class="row text-center">
                <div class="col-12">
                  <small class="text-muted">
                    <i class="fas fa-shield-alt me-1"></i>
                    <strong>Documents stored securely & accessible via links.</strong>
                    {% if docs|selectattr('drive_link')|list|length > 0 %}
                    <br><i class="fas fa-cloud me-1"></i>{{ docs|selectattr('drive_link')|list|length }} doc(s) backed up to Drive.
                    {% else %}
                    <br><i class="fas fa-info-circle me-1"></i>Setup Google Drive for cloud sync.
                    {% endif %}
                  </small>
                </div>
              </div>
            </div>
          </div>
        </div>
        {% else %}
        <div class="apple-card mb-4 apple-slide-up" style="animation-delay:0.2s;">
          <div class="apple-card-body text-center py-5">
            <i class="fas fa-file-alt fa-3x mb-3" style="color:var(--apple-gray);opacity:0.3;"></i>
            <h6 style="color:var(--apple-gray);">No Documents Uploaded</h6>
            <p class="text-muted mb-3">Upload important documents like RC, Insurance, Emission Test</p>
            {% if role=='admin' %}
            <a href="{{ url_for('upload_document', car_id=v.reg_no) }}" class="apple-btn apple-btn-primary">
              <i class="fas fa-plus me-1"></i>Upload First Document
            </a>
            {% endif %}
          </div>
        </div>
        {% endif %}
      </div>
    </div>

    <!-- Assign Driver, Maintenance, etc. can follow here -->

  </div>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
